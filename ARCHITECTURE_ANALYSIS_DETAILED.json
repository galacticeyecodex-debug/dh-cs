{
  "analysis_summary": {
    "total_issues": 4,
    "total_effort_hours": "128-177",
    "estimated_timeline_months": "4-6 (single developer) or 2-3 (two developers)",
    "critical_issues": 3,
    "high_issues": 1
  },
  "issues": [
    {
      "issue_name": "Issue 1: Monolithic Character Store (826 lines)",
      "file": "store/character-store.ts",
      "severity": "HIGH",
      "root_cause": "Single Zustand store mixes 7 distinct concerns: auth, character data, UI state, vital modifications, inventory, game logic, DB persistence. Violates Single Responsibility Principle.",
      "impact": {
        "maintainability": "CRITICAL",
        "testability": "CRITICAL",
        "reusability": "HIGH",
        "performance": "MEDIUM",
        "team_velocity": "HIGH"
      },
      "key_problems": [
        "Cannot test game logic in isolation",
        "Armor calculations duplicated in store, components, utils",
        "Changes to one concern risk breaking others",
        "New feature requires understanding full store",
        "No way to reuse logic for NPCs or character builders"
      ],
      "recommended_fix": {
        "strategy": "Split into 5 focused Zustand stores",
        "stores": [
          { "name": "authStore", "functions": ["fetchUser()", "setUser()"] },
          { "name": "characterStore", "functions": ["fetchCharacter()", "switchCharacter()", "setCharacter()"] },
          { "name": "gameLogicStore", "functions": ["calculateArmorScore()", "calculateThresholds()", "recalculateDerivedStats()"] },
          { "name": "vitalsStore", "functions": ["updateVitals()", "updateGold()", "updateHope()", "updateEvasion()"] },
          { "name": "uiStateStore", "functions": ["setActiveTab()", "openDiceOverlay()", "prepareRoll()"] },
          { "name": "inventoryStore", "functions": ["equipItem()", "addItemToInventory()", "moveCard()"] }
        ]
      },
      "effort_estimate": "40-60 hours",
      "effort_breakdown": {
        "extract_game_logic": "8-10 hours",
        "create_new_stores": "12-16 hours",
        "update_components": "12-16 hours",
        "testing": "6-10 hours",
        "documentation": "2-4 hours"
      },
      "reproduction_steps": [
        "Try to test armor calculation in isolation - cannot without mocking entire store",
        "Trace armor logic: recalculateDerivedStats -> common-vitals-display -> utils.getSystemModifiers",
        "Add new armor feature - requires changes in 3+ files across different layers"
      ]
    },
    {
      "issue_name": "Issue 2: Zero Test Coverage",
      "severity": "CRITICAL",
      "root_cause": "No test infrastructure (no jest.config, vitest.config, __tests__ directories). Monolithic store prevents isolated testing. Pure functions mixed with side effects.",
      "impact": {
        "regression_risk": "CRITICAL",
        "deployment_confidence": "CRITICAL",
        "new_developer_onboarding": "HIGH"
      },
      "critical_unprotected_functions": [
        "recalculateDerivedStats() - Complex 4-source modification (base, system, manual, caps)",
        "getSystemModifiers() - Regex parsing edge cases",
        "updateVitals() - Vital clamping logic",
        "equipItem() - Item swap atomicity (2 DB calls)",
        "fetchCharacter() - Data hydration & backward migration"
      ],
      "recommended_fix": {
        "framework": "Vitest (recommended over Jest for Next.js 15)",
        "reason": "Better ESM support, faster execution, native TypeScript, smaller config",
        "phase_1_unit_tests": {
          "scope": "Pure game logic (armor, thresholds, modifiers, data transforms)",
          "tests": "45-55 tests",
          "effort_hours": "20-25"
        },
        "phase_2_integration_tests": {
          "scope": "Store actions (loading, updates, cascading effects)",
          "tests": "20-24 tests",
          "effort_hours": "15-20"
        },
        "phase_3_component_tests": {
          "scope": "UI interactions (VitalCard, Inventory, Modifiers)",
          "tests": "14-18 tests",
          "effort_hours": "15-20"
        }
      },
      "effort_estimate": "50-65 hours",
      "effort_breakdown": {
        "setup_vitest": "3-5 hours",
        "phase_1_unit_tests": "20-25 hours",
        "phase_2_integration_tests": "15-20 hours",
        "phase_3_component_tests": "15-20 hours",
        "ci_cd_setup": "3-5 hours"
      },
      "critical_test_cases": [
        {
          "function": "recalculateDerivedStats()",
          "must_test": [
            "Armor caps at 12 per SRD",
            "Armor slots capped at armor_score during recalc",
            "Damage thresholds include armor bonuses",
            "HP max = class_base + system_mods + user_mods",
            "Unarmored (armor_score=0) defaults applied correctly"
          ]
        },
        {
          "function": "getSystemModifiers(character, stat)",
          "must_test": [
            "Structured modifiers parsed from array",
            "Regex fallback for legacy text",
            "Multiple mods from same item stack",
            "Unequipped items ignored",
            "Invalid regex doesn't crash"
          ]
        },
        {
          "function": "updateVitals(type, value)",
          "must_test": [
            "HP clamped [0, max]",
            "Armor clamped [0, armor_score]",
            "Stress clamped [0, stress_max]",
            "DB error triggers rollback",
            "Concurrent updates handled"
          ]
        },
        {
          "function": "equipItem(itemId, slot)",
          "must_test": [
            "Item moves to correct slot",
            "Previous item in slot moves to backpack",
            "Unequipping works",
            "DB error reverts both changes",
            "Triggers recalc"
          ]
        },
        {
          "function": "fetchCharacter(userId, characterId)",
          "must_test": [
            "Data loaded with relations",
            "Legacy vitals migration (hp_current -> hit_points_current)",
            "Experiences string[] -> Experience[] conversion",
            "Library items joined correctly",
            "Class data fetched",
            "No race conditions on concurrent fetches"
          ]
        }
      ]
    },
    {
      "issue_name": "Issue 3: Race Condition in fetchCharacter (line 794)",
      "file": "store/character-store.ts",
      "line": 794,
      "severity": "HIGH",
      "root_cause": "setTimeout(() => get().recalculateDerivedStats(), 0) defers recalc asynchronously. If user action (equipItem) occurs before recalc completes, derived stats calculated with stale inventory.",
      "impact": {
        "data_corruption": "MEDIUM",
        "user_experience": "MEDIUM",
        "likelihood": "MEDIUM (requires <16ms timing)"
      },
      "race_condition_scenario": {
        "timeline": [
          "t=0ms: fetchCharacter() sets character with equipped armor",
          "t=0ms: setTimeout schedules recalculateDerivedStats()",
          "t=2ms: User clicks equipItem() to swap armor",
          "t=2ms: equipItem() updates character.character_inventory in state",
          "t=10ms: recalculateDerivedStats() executes with new armor",
          "RESULT: Armor calculated twice, second overwrite possible if equipItem's recalc incomplete"
        ]
      },
      "specific_corruption_example": {
        "scenario": "No armor equipped initially",
        "steps": [
          "Character loads (armor_score = 0)",
          "setTimeout schedules recalc",
          "User equips Heavy Armor (base_score = 3) via equipItem()",
          "equipItem() calls recalculateDerivedStats() directly",
          "equipItem's recalc completes, armor_score = 3 persisted to DB",
          "setTimeout's recalc fires from closure with old state",
          "fetchCharacter's recalc overwrites armor_score back to 0"
        ]
      },
      "recommended_fix": {
        "approach": "Create fetchCharacterAndInitialize wrapper action",
        "pseudocode": [
          "// Replace line 794 setTimeout with:",
          "const calculated = await recalculateDerivedStatsForCharacter(fullCharacter)",
          "set(s => ({ character: s.character ? { ...s.character, ...calculated } : null }))",
          "await persistDerivedStats(character.id, calculated)"
        ],
        "benefits": [
          "Eliminates setTimeout race condition",
          "All operations sequential within single action",
          "Derived stats calculated on new state before persistence"
        ]
      },
      "additional_safeguards": [
        "Add version/timestamp to derived stats to detect staleness",
        "Verify inventory unchanged between calc and persistence",
        "Assert armor_score <= 12 in updateVitals",
        "Test rapid equipItem + fetchCharacter sequence"
      ],
      "effort_estimate": "8-12 hours",
      "effort_breakdown": {
        "refactor_fetchCharacter": "4-6 hours",
        "add_safeguards": "2-3 hours",
        "write_race_condition_tests": "2-3 hours"
      }
    },
    {
      "issue_name": "Issue 4: Error Recovery Missing (8 functions)",
      "file": "store/character-store.ts",
      "lines": "205-208, 457-460, 482-484, 507-510, 559-561, 605-608, 822-825",
      "severity": "CRITICAL",
      "root_cause": "Store uses optimistic updates (update UI immediately, then DB) with zero error handling. When DB fails, optimistic state persists, creating client-server inconsistency.",
      "impact": {
        "data_consistency": "CRITICAL",
        "user_trust": "CRITICAL",
        "cascading_failures": "HIGH",
        "state_explosion": "HIGH"
      },
      "affected_functions": [
        {
          "function": "moveCard()",
          "line": "205-208",
          "risk": "Card location out of sync",
          "impact": "Affects 30+ cards"
        },
        {
          "function": "updateGold()",
          "line": "457-460",
          "risk": "Gold entry lost",
          "impact": "Accounting error"
        },
        {
          "function": "updateHope()",
          "line": "482-484",
          "risk": "Hope out of sync",
          "impact": "Affects all rolls (HIGH)"
        },
        {
          "function": "updateEvasion()",
          "line": "507-510",
          "risk": "Evasion out of sync",
          "impact": "Affects all rolls (HIGH)"
        },
        {
          "function": "updateModifiers()",
          "line": "533-536",
          "risk": "Modifiers disappear",
          "impact": "Bonus stats lost"
        },
        {
          "function": "updateExperiences()",
          "line": "559-561",
          "risk": "Experience tracking lost",
          "impact": "Progression lost"
        },
        {
          "function": "equipItem()",
          "line": "605-608",
          "risk": "2 sequential DB calls without atomicity",
          "impact": "Inventory inconsistent (item in 2 slots)"
        },
        {
          "function": "updateVitals()",
          "line": "822-825",
          "risk": "HP/Armor/Stress out of sync",
          "impact": "CRITICAL gameplay impact (used constantly)"
        }
      ],
      "error_scenarios": [
        {
          "scenario": "Silent data loss",
          "steps": [
            "User marks armor down (visual feedback: reduced)",
            "DB update fails (network offline)",
            "User refreshes",
            "Armor reverts to full (optimistic update lost)",
            "User confused: 'Where did my click go?'"
          ]
        },
        {
          "scenario": "Equipment swap fails partially",
          "steps": [
            "User swaps Sword A (equipped) with Sword B (backpack)",
            "Sword A -> backpack: DB succeeds",
            "Sword B -> equipped: DB fails",
            "Client: Sword B equipped, Sword A in backpack",
            "Server: Sword A in backpack, Sword B unequipped",
            "On refresh: Inventory inconsistent"
          ]
        },
        {
          "scenario": "Concurrent operations during error state",
          "steps": [
            "Reduce armor to 2 (optimistic), DB fails",
            "Reduce armor to 1 (optimistic), DB fails",
            "Increase armor to 3 (optimistic), DB succeeds",
            "Client shows 3, server shows original value",
            "Next recalc uses wrong armor_score"
          ]
        }
      ],
      "recommended_fix": {
        "primary_approach": "Optimistic with rollback (better UX)",
        "alternative_approach": "Pessimistic updates (safer, less modern UX)",
        "pattern": {
          "step_1": "Store previous state before optimistic update",
          "step_2": "Optimistically update UI immediately",
          "step_3": "Persist to DB asynchronously",
          "step_4": "If DB fails: rollback UI to previous state",
          "step_5": "Show error toast with clear message",
          "step_6": "Offer retry button"
        },
        "pseudocode": {
          "function": "updateVitals(type, value)",
          "code": [
            "// 1. Store previous state",
            "const previousVitals = state.character.vitals",
            "",
            "// 2. Calculate new value",
            "const actualValue = clampVital(type, value, newVitals)",
            "const updatedVitals = { ...newVitals, [type]: actualValue }",
            "",
            "// 3. Optimistically update UI",
            "set(s => ({",
            "  character: s.character ? { ...s.character, vitals: updatedVitals } : null",
            "}))",
            "",
            "// 4. Persist to DB",
            "try {",
            "  const { error } = await supabase",
            "    .from('characters')",
            "    .update({ vitals: updatedVitals })",
            "    .eq('id', state.character.id)",
            "  if (error) throw error",
            "} catch (error) {",
            "  // 5. Rollback on failure",
            "  set(s => ({",
            "    character: s.character ? { ...s.character, vitals: previousVitals } : null",
            "  }))",
            "  showErrorToast(`Failed to save ${type}. Your change was reverted.`)",
            "}"
          ]
        }
      },
      "error_notification_strategy": [
        "Install toast library (react-hot-toast or sonner)",
        "Show clear messages: 'Failed to save armor. Please try again.'",
        "Provide retry button for critical operations",
        "Track error count - suggest refresh if 3+ failures"
      ],
      "implementation_priority": [
        {
          "priority": 1,
          "function": "updateVitals()",
          "reason": "High usage, critical gameplay impact",
          "effort": "4-6 hours"
        },
        {
          "priority": 2,
          "function": "equipItem()",
          "reason": "Complex multi-step operation",
          "effort": "5-7 hours"
        },
        {
          "priority": 3,
          "function": "updateModifiers() -> recalculate()",
          "reason": "Affects all stats",
          "effort": "4-5 hours"
        },
        {
          "priority": 4,
          "function": "updateGold(), updateHope(), updateEvasion()",
          "reason": "Lower usage",
          "effort": "6-8 hours"
        },
        {
          "priority": 5,
          "function": "moveCard(), addCardToCollection()",
          "reason": "UI-only operations",
          "effort": "3-5 hours"
        }
      ],
      "effort_estimate": "30-40 hours",
      "effort_breakdown": {
        "error_ui_library": "1-2 hours",
        "updateVitals_pattern": "4-6 hours",
        "equipItem_pattern": "5-7 hours",
        "other_functions": "10-12 hours",
        "retry_logic": "3-5 hours",
        "error_recovery_tests": "5-8 hours"
      }
    }
  ],
  "combined_effort_summary": {
    "issue_1_monolithic_store": "40-60 hours",
    "issue_2_zero_tests": "50-65 hours",
    "issue_3_race_condition": "8-12 hours",
    "issue_4_error_recovery": "30-40 hours",
    "total_effort_hours": "128-177 hours",
    "team_composition_estimates": {
      "single_developer": "4-6 months",
      "two_developers": "2-3 months",
      "three_developers": "6-8 weeks"
    }
  },
  "recommended_priority_order": [
    {
      "phase": 1,
      "duration_weeks": "1-2",
      "effort_hours": "20-25",
      "focus": "Issue #2 Phase 1 - Add Vitest & unit tests for game logic",
      "rationale": "Enables safe refactoring. No-risk improvement to codebase. Foundation for all other changes."
    },
    {
      "phase": 2,
      "duration_weeks": "3-4",
      "effort_hours": "8-12",
      "focus": "Issue #3 - Fix race condition in fetchCharacter()",
      "rationale": "Prevents data corruption. Moderate complexity. Isolated fix."
    },
    {
      "phase": 3,
      "duration_weeks": "5-7",
      "effort_hours": "15-20",
      "focus": "Issue #4 - Add error recovery for critical functions",
      "rationale": "Prevents silent data loss. High user-facing impact. Can be done incrementally."
    },
    {
      "phase": 4,
      "duration_weeks": "8-9",
      "effort_hours": "15-20",
      "focus": "Issue #2 Phase 2-3 - Integration and component tests",
      "rationale": "Solidifies test coverage. Tests refactoring work."
    },
    {
      "phase": 5,
      "duration_weeks": "10-20",
      "effort_hours": "40-60",
      "focus": "Issue #1 - Monolithic store refactoring",
      "rationale": "Largest effort. Should be last to minimize disruption. Tests provide safety net."
    }
  ],
  "risk_assessment": {
    "issue_1": {
      "impact": "CRITICAL",
      "likelihood": "ALWAYS_PRESENT",
      "effort": "40-60 hours",
      "risk_score": "HIGH"
    },
    "issue_2": {
      "impact": "CRITICAL",
      "likelihood": "ON_EVERY_REFACTOR",
      "effort": "50-65 hours",
      "risk_score": "CRITICAL"
    },
    "issue_3": {
      "impact": "MEDIUM",
      "likelihood": "MODERATE",
      "effort": "8-12 hours",
      "risk_score": "MEDIUM"
    },
    "issue_4": {
      "impact": "CRITICAL",
      "likelihood": "COMMON_NETWORK_FAILURES",
      "effort": "30-40 hours",
      "risk_score": "CRITICAL"
    }
  },
  "recommendations": {
    "immediate_actions": [
      "Set up Vitest (1-2 weeks)",
      "Write game logic unit tests (HIGH ROI)",
      "Fix race condition (isolated, moderate effort)"
    ],
    "short_term": [
      "Implement error recovery for updateVitals()",
      "Add error notification UI",
      "Implement rollback pattern for equipItem()"
    ],
    "medium_term": [
      "Extend error recovery to all 8 affected functions",
      "Write integration tests for store actions",
      "Begin gameLogicStore extraction"
    ],
    "long_term": [
      "Complete store refactoring (5 stores)",
      "Add component-level integration tests",
      "Add CI/CD test automation",
      "Document store architecture"
    ]
  }
}
